@model CI_Platform.Entities.ViewModels.MissionDetailViewModel

@{
    ViewData["Title"] = "Volunteering Mission Page";
    Layout = "_Layout";
    //var UserId = Convert.ToInt64(ViewBag.UserId);
    ////var mission_id = ViewBag.MissionId;
    var mission_id = Model.MissionDetails.MissionId;
}

<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />

<div class="container py-5">
    <div class="row volunteer-card">
        <div class="col-lg-6">
            <div style="--swiper-navigation-color: #fff; --swiper-pagination-color: #fff" class="swiper mySwiper2">
                <div class="swiper-wrapper">
                    @if (Model.MissionDetails.MissionMedia.Any(m => m.MissionId != mission_id))
                    {
                        <img src="~/images/no-image.png" alt=" " />
                    }
                    else
                    { 
                        @foreach (var slider_img in Model.MissionDetails.MissionMedia.Where(m => m.MissionId == mission_id))
                        {
                            <div class="swiper-slide">
                                <img src="~/images/@slider_img.MediaPath" />
                            </div>
                        }                 
                    }
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
            <div thumbsSlider="" class="swiper mySwiper">
                <div class="swiper-wrapper">
                    @foreach (var slider_img in Model.MissionDetails.MissionMedia.Where(m => m.MissionId == mission_id))
                    {
                        <div class="swiper-slide">
                            <img src="~/images/@slider_img.MediaPath" />
                        </div>
                    }

                  

                </div>

            </div>
        </div>



        @{

            var Id = Convert.ToInt64(ViewBag.UserId);

          
            var count = Model.MissionDetails.MissionRatings.Count();
            double avg_rating = 0;
            if (Model.MissionDetails.MissionRatings.Count > 0)
            {
                avg_rating = Model.MissionDetails.MissionRatings.Average(r => r.Rating); 
            }
            DateTime? currDate = @DateTime.Now;
            TimeSpan timeSpan = new TimeSpan(1, 0, 0, 0);
            var deadline = Model.MissionDetails.StartDate - timeSpan;
            bool isDeadlinePassed = currDate > deadline;
            bool isEndDatePassed = currDate > Model.MissionDetails.EndDate;
            bool isOngoing = currDate > Model.MissionDetails.StartDate;
            bool isAlreadyApplied = Model.MissionDetails.MissionApplications.Any(a => a.UserId == Id && a.ApprovalStatus=="APPROVE");
           
            double userRate = 0;
            if (Model.MissionDetails.MissionRatings.Where(u => u.UserId == Id).Any())
            {
                var rate = Model.MissionDetails.MissionRatings.Where(r => r.UserId == Id).FirstOrDefault();
                userRate = rate.Rating;
            }
            var registered_users = Model.MissionDetails.MissionApplications.Count(m => m.ApprovalStatus.Contains("APPROVE"));
            var seats_left = Model.MissionDetails.TotalSeats - registered_users;
        }
        
        
      
    <div class="col-lg-6">
            <div class="volunteer-card-details py-4 px-4">
               
                <h2 class="volunteer-card-title">

                   @Model.MissionDetails.Title
                </h2>
                <p class="card-text py-2">

                    @Model.MissionDetails.ShortDescription
                </p>

                <div class="card-body ">
                    <div class="mission-detail-border position-relative">
                        <div class="rounded-pill capsule-border capsule-transparent">
                            
                               @if (Model.MissionDetails.MissionType.Equals("Time"))
                                    {
                                        if(isOngoing)
                                        {
                                    <span>Ongoing Opportunity</span>
                                        }
                                        else{
                                    <span>From @Model.MissionDetails.StartDate.Value.ToShortDateString() until @Model.MissionDetails.EndDate.Value.ToShortDateString()</span>
                                        }
                                    }
                                    else
                                    {
                                        @foreach (var goal_mission in Model.MissionDetails.GoalMissions)
                                        {
                                            @goal_mission.GoalObjectiveText
                                        }
                                    }
                            
                        </div>
                    </div>


                    <div class="row pb-3 gutter mt-4 ">
                        <div class="col  card-detail mission-card-detail">
                            <img class="my-2" src="~/images/Seats-left.png"
                                 alt="star">
                            <div class="card-detail-text">
                                <p>@seats_left</p>
                                <span>Seats left</span>
                            </div>
                        </div>

                        @foreach (var goal_mission in Model.MissionDetails.GoalMissions)
                        {
                            <div class="col card-detail mission-card-detail">
                                <img class="icon-detail my-2" src="~/images/achieved.png" alt="achieved">
                                <div class="card-detail-text">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" aria-label="Warning example" style="background-color: #F88634; width:@goal_mission.GoalValue%" aria - valuenow="@goal_mission.GoalValue" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <span>@goal_mission.GoalValue achieved</span>
                                </div>
                            </div>
                        }


                   
                    </div>
                    <div class="mission-detail-border"> </div>
                    <div class="d-flex flex-column flex-md-row">
                            @if (Model.MissionDetails.FavouriteMissions.Any(fm => fm.UserId == Id))
                            {
                                <button class=" capsule-details " onclick="favourite()">
                                    <i class="bi bi-heart-fill favourite-button filled-heart text-danger" data-mission-id="@Model.MissionDetails.MissionId"></i>
                                    <span class="favText">Remove from Favourites</span>
                                </button>
                            }
                            else
                            {
                            <button class="   capsule-details " onclick="favourite()">
                                <i class="bi bi-heart empty-heart text-dark favourite-button " data-mission-id="@Model.MissionDetails.MissionId"></i>
                                <span class="favText">Add To Favourites</span>
                            </button>
                            }

                        <button type="submit" class="capsule-details text-dark"  data-bs-toggle="modal" data-bs-target="#exampleModalCenter">
                            <i class="bi bi-people"></i>
                            Recommended To a Co-Worker
                        </button>

                        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLongTitle">Recommend to a Co-Worker</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        @foreach (var u in Model.UserList)
                                        {

                                            

                                            <div class="mt-2" style="display : flex; justify-content : space-between;">

                                                <span class="me-4 ">@u.FirstName @u.LastName</span>

                                                @if(u.MissionInviteToUsers.Any(i=>i.ToUserId == u.UserId)) 
                                                {
                                                    <span style="margin-left : 6%;" mailto:class="invited-@u.UserId"><button class="btn btn-success model-button model-invite-btn disabled" data-mission-id="@mission_id" data-from-user-id="@Id" data-to-user-id="@u.UserId">Invite</button></span>

                                                } else
                                                {
                                                    <span style="margin-left : 6%;" mailto:class="invited-@u.UserId"><button class="btn btn-outline-primary model-button model-invite-btn" data-mission-id="@mission_id" data-from-user-id="@Id" data-to-user-id="@u.UserId">Invite</button></span>

                                                    @*<div class="col-auto" mailto:class="invited-@coworker.userid"><button type="button" class="btn btn-outline-primary modal-invite-btn" data-mission-id="@Model.Mission.MissionId" data-user-id="@UserId" data-coworker-id="@coworker.UserId">Invite</button></div>*@
                                                }
                                                @*<span style="margin-left : 6%;" mailto:class="invited-@u.UserId"><button class="btn btn-outline-primary model-button model-invite-btn" data-mission-id="@mission_id" data-from-user-id="@Id" data-to-user-id="@u.UserId">Invite</button></span>*@

                                            </div>
                                        }
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                    <div class="mission-detail-border position-relative">
                        <div class="rounded-pill capsule-transparent stars">
                            <div class="rating-star m-2">
                                @for (var i = 1; i <= @userRate; i++)
                                {
                                    <i class="bi bi-star-fill text-warning m-2" data-mission-Id="@mission_id"></i>

                                }
                                @for (var i = 5; i > @userRate; i--)
                                {
                                    <i class="bi bi-star m-2" data-mission-Id="@mission_id"></i>
                                }

                            </div>
                        </div>
                    </div>

                    <div class="row my-5">
                        <div class="col-md-3 col-6">
                            <div class="mission-detail-box">
                                <img class="icon" src="~/images/pin1.png" />
                                <p>City<br /><span>@Model.MissionDetails.City.CityName</span></p>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="mission-detail-box">
                                <img class="icon" src="~/images/web.png" />
                                <p>Theme<br /><span>@Model.MissionDetails.MissionTheme.Title</span></p>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="mission-detail-box">
                                <img class="icon" src="~/images/calender.png" />
                                <p>Date<br /><span>
                                        @if(isOngoing)
                                        {
                                        <span>Ongoing Opportunity</span>
                                        }
                                        else{
                                        <span>From @Model.MissionDetails.StartDate.Value.ToShortDateString() until @Model.MissionDetails.EndDate.Value.ToShortDateString()</span>
                                        }

                                </span></p>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="mission-detail-box">
                                <img class="icon" src="~/images/organization.png" />
                                <p>Organisation<br /><span>@Model.MissionDetails.OrganizationName</span></p>
                            </div>
                        </div>
                    </div>
                    @if (isAlreadyApplied)
                    {
                        <div class="d-flex justify-content-center">
                            <a style="width:max-content " class="btn card-btn disabled text-success">
                                Already Applied
                            </a>
                        </div>
                    }
                    else if(isDeadlinePassed || isEndDatePassed || seats_left <=0 )
                    {
                        <div class="d-flex justify-content-center">
                            <a style="width:max-content" class="btn card-btn disabled text-danger">
                                Closed
                               
                            </a>
                        </div>
                    }
                    else{
                    <div class="d-flex justify-content-center">
                        <a style="width:max-content" class="btn card-btn" id="ApplyBtnMission" data-mission-id="@mission_id">
                            Apply Now &nbsp; &nbsp;
                            <img src="~/images/right-arrow.png">
                            <img src="~/images/right-arrow2.png">
                        </a>
                    </div>
                    }

                </div>
            </div>
        </div>
    </div>

    <div class="row my-5">
        <div class="col-lg-8">
            <ul class="nav nav-tabs" style="border-bottom:1px solid #E8E8E8" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#Mission">Mission</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#Organization">Organization</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#Comments">Comments</a>
                </li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
                <div id="Mission" class="container tab-pane active">
                    <br>
                    <h3>Introduction</h3>
                    <p>@Model.MissionDetails.Description</p>
                    <h3>Challenge</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    <h3>Documents</h3>
                    <div class="d-flex flex-column flex-md-row">
                        @if (Model.MissionDetails.MissionDocuments.Any())
                        {
                            @foreach(var doc in Model.MissionDetails.MissionDocuments)
                            {
                                <div class="capsule-details">
                                        <a class="text-decoration-none" href="@Url.Action("DisplayDocument", "Home", new { fileName = @doc.DocumentPath })" target="_blank">
                                            <img src="~/images/pdf.png" />
                                            &nbsp;@doc.DocumentName
                                        </a>
                                </div> 
                            }
                        }
                        else
                        {
                            <span>No Documents are uploaded for this mission</span>
                        }
                    </div>

                </div>
                <div id="Organization" class="container tab-pane fade">
                    <br>
                    <h3>Organization </h3>
                    <p>@Model.MissionDetails.OrganizationDetail</p>
                     </div>
                <div id="Comments" class="container tab-pane fade">
                    <br>
                    <h3>Comments</h3>
                    <form method="post" >
                        <div class="form-floating" >
                            <textarea class="form-control my-2 newComment" placeholder="Leave a comment here"  style="height: 100px"></textarea>
                           @* <label for="floatingTextarea2">Enter your Comments here...</label>*@
                        </div>
                        <button class="btn card-btn commentButton" data-mission-Id="@mission_id">Post Comment</button>
                    </form>
                    <div class="container mt-2 bg-light overflow-scroll p-4" style="max-height:30rem">
                        @foreach (var com in Model.ApprovedComments)
                        {
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="d-flex">
                                        <img class="rounded-circle comments-img d-none d-md-flex" src= @com.User.Avtar />
                                        <div class="comments-details">
                                                <h6>@com.User.FirstName @com.User.LastName</h6>
                                                <p> @com.CreatedAt.Value.ToString("dddd, MMMM dd, yyyy, h:mm tt")</p>
                                                <p>@com.CommentText</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        }
                    </div>

                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="container table-info">
                <table class="table">
                    <tr>
                        <td style="border-bottom:2px solid black;">Information</td>
                        <td></td>
                    </tr>
                    <tbody>
                        <tr>
                            <td scope="row">Skills</td>
                            <td>

                                @if (Model.MissionDetails.MissionSkills.Any())
                                {
                                    @foreach (var skill in Model.MissionDetails.MissionSkills)
                                    {
                                        <span>@skill.Skill.SkillName  <br>  </span>
                                    }
                                } 
                                else
                                {
                                    <span>No Skills required</span>
                                }

                                

                                
                            </td>
                        </tr>
                        <tr>
                            <td scope="row">Days</td>
                            <td>@Model.MissionDetails.Availability</td>
                        </tr>
                        <tr class="table-last-row">
                            <td scope="row">Ratings</td>
                            <td>
                                @for (var i = 1; i <= avg_rating; i++)
                                {
                                    <img src="~/images/selected-star.png" />
                                }
                                @for (var i = 5; i > avg_rating; i--)
                                {
                                    <img src="~/images/star.png" />
                                }
                               
                                <span>(by @count volunteers)</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="container volunteers-images-div">
                <h5>Recent Volunteers</h5>
                
                    @if (Model.RecentVolunteers.Any())
                    {
                    <div class="volunteerd-images">
                        @foreach(var recent in Model.RecentVolunteers)
                        {
                            <div class="volunteerd-img">
                                <img src="~/images/@recent.User.Avtar" />
                                <figcaption>@recent.User.FirstName  @recent.User.LastName </figcaption>
                            </div>
                        }
                    </div>
                    }
                    else
                    {
                        <div> No Recent Volunteers in this mission </div>
                    }
                
                </div>
            </div>
        </div>

    </div>
    <div class="border-navbar my-5"></div>
    <div class="container mt-5">
        <h2 style="color:#414141; font-weight:normal; text-align:center" >Releated Missions</h2>
        <div class="container my-5" id="grid-view">
            <div class=" row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-sm-1   g-4">
                <!-- Card starts from col -->
            @if (Model.RelatedMissions.Any())
            {
                @foreach(var releated in Model.RelatedMissions)
                {
                <div class="col">
                        <div class="card  ">
                            <div class="pill-on-img">
                                @if (!releated.MissionMedia.Any())
                                {
                                    <img src="~/images/no-image.png" class="card-img-top" />
                                }
                                else
                                {
                                    @foreach (var img_mission in releated.MissionMedia)
                                    {
                                        @if (img_mission.Defaultval == true)
                                        {
                                            <img src="~/images/@img_mission.MediaPath" class="card-img-top" alt="@img_mission.MediaName">
                                        }
                                    }
                                }
                                <div class="location">
                                    <img src="~/images/pin1.png">
                                    @releated.City.CityName
                                </div>
                                <div class="like-on-img">
                                    <img style="opacity: 1;" src="~/images/heart.png">
                                </div>
                                <div class="add-on-img">
                                    <img style="opacity: 1;" src="~/images/add1.png">
                                </div>
                                <div class="theme-pill rounded-pill"> @releated.MissionTheme.Title </div>
                            </div>
                            <div class="card-body">
                                <h3 class="card-title">@releated.Title</h3>
                                <p class="card-text align-items-center">@releated.ShortDescription</p>
                                <div class="d-flex justify-content-between">
                                    @releated.OrganizationName
                                    <div class="stars">
                                        @for (int i = 1; i <= avg_rating; i++)
                                        {
                                            <img src="~/images/selected-star.png" />
                                        }
                                        @for (int i = 5; i > avg_rating; i--)
                                        {
                                            <img src="~/images/star.png" />
                                        }

                                    </div>
                                </div>
                            </div>

                            @if (isEndDatePassed || isAlreadyApplied || seats_left <= 0 || isDeadlinePassed)
                            {
                                <div class=" d-flex pb-3 justify-content-center">
                                    <a class="btn btn card-btn"@* href="@Url.Action("MissionDetail", "Home" , new { MissionId = @obj.MissionId})"*@>
                                        View Details &nbsp;&nbsp;<img src="~/images/right-arrow.png" />
                                        <img src="~/images/right-arrow2.png" />
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="m-3 list-group position-relative ">
                                    <div class="time-pill rounded-pill ">
                                        @if (releated.MissionType.Equals("Time"))
                                        {
                                            if (isOngoing)
                                            {
                                                <span>Ongoing Opportunity</span>
                                            }
                                            else
                                            {
                                                <span>From @releated.StartDate.Value.ToShortDateString() until @releated.EndDate.Value.ToShortDateString()</span>
                                            }
                                        }
                                        else
                                        {
                                            @foreach (var goal_mission in releated.GoalMissions)
                                            {
                                                @goal_mission.GoalObjectiveText
                                            }
                                        }
                                    </div>
                                    <div class="row gutter mt-4 mb-2 justify-content-around">
                                        <div class="col card-detail">
                                            <img class="icon-detail my-2" src="~/images/Seats-left.png" alt="seats left">
                                            <div class="card-detail-text">

                                                <p class="seat-left">  @seats_left </p>
                                                <span>Seats left</span>
                                            </div>
                                        </div>
                                        @if (releated.MissionType.Equals("Time"))
                                        {
                                            <div class="col card-detail">
                                                <img class="icon-detail my-2" src="~/images/deadline.png" alt="deadline">
                                                <div class="card-detail-text ">
                                                    <p class="deadline">@releated.StartDate.Value.AddDays(-1).ToShortDateString()</p>
                                                    <span>Deadline</span>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            @foreach (var goal_mission in releated.GoalMissions)
                                            {
                                                <div class="col card-detail">
                                                    <img class="icon-detail my-2" src="~/images/achieved.png" alt="deadline">
                                                    <div class="card-detail-text">
                                                        <div class="progress">
                                                            <div class="progress-bar" role="progressbar" aria-label="Warning example" style="background-color: #F88634; width:@goal_mission.GoalValue%" aria - valuenow="@goal_mission.GoalValue" aria-valuemin="0" aria-valuemax="100"></div>
                                                        </div>
                                                        <span>@goal_mission.GoalValue achieved</span>
                                                    </div>
                                                </div>
                                            }

                                        }
                                    </div>
                                </div>


                                <div class=" d-flex pb-3 justify-content-center">
                                    <a class="btn card-btn">
                                        Apply  &nbsp;&nbsp;&nbsp;
                                        <img src="~/images/right-arrow.png">
                                        <img src="~/images/right-arrow2.png" />
                                    </a>
                                </div>

                            }
                         </div>
                         </div>
            }
                <!-- card 1 ends here and card 2 starts -->
            }
            else
            {
                <div >
                    <h3 class="d-flex justify-content-center">No Releated Missions Found</h3>
                </div>
            }

        
       
        
            </div>
        </div>
    </div>

</div>




<script>
    var swiper = new Swiper(".mySwiper", {
        loop: true,
        spaceBetween: 10,
        slidesPerView: 3,
        freeMode: true,
        watchSlidesProgress: true,
    });
    var swiper2 = new Swiper(".mySwiper2", {
        loop: true,
        spaceBetween: 10,
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        thumbs: {
            swiper: swiper,
        },
    });
</script>